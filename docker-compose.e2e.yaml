services:
  # ============================================================================
  # Infrastructure
  # ============================================================================

  tailscale:
    image: tailscale/tailscale:latest
    container_name: e2e-tailscale
    hostname: e2e-docktail
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SOCKET=/var/run/tailscale/tailscaled.sock
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--advertise-tags=tag:ci-test
    volumes:
      - ts-state:/var/lib/tailscale
      - ts-socket:/var/run/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: host
    restart: "no"
    healthcheck:
      test: ["CMD", "tailscale", "status", "--json"]
      interval: 2s
      timeout: 5s
      retries: 30

  docktail:
    build: .
    container_name: e2e-docktail
    depends_on:
      tailscale:
        condition: service_healthy
    restart: "no"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ts-socket:/var/run/tailscale
    environment:
      - LOG_LEVEL=debug
      - RECONCILE_INTERVAL=5s
      - DEFAULT_SERVICE_TAGS=tag:ci-test-container
      - TAILSCALE_OAUTH_CLIENT_ID=${TS_OAUTH_CLIENT_ID:-}
      - TAILSCALE_OAUTH_CLIENT_SECRET=${TS_OAUTH_CLIENT_SECRET:-}
      - TAILSCALE_TAILNET=${TS_TAILNET:-}

  # ============================================================================
  # 1. Service Protocol Variations
  # ============================================================================

  # HTTP service with explicit config
  test-proto-http:
    image: nginx:alpine
    container_name: e2e-proto-http
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-proto-http"
      - "docktail.service.port=80"
      - "docktail.service.protocol=http"
      - "docktail.service.service-port=80"
      - "docktail.service.service-protocol=http"

  # HTTPS service protocol
  test-proto-https:
    image: nginx:alpine
    container_name: e2e-proto-https
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-proto-https"
      - "docktail.service.port=80"
      - "docktail.service.protocol=http"
      - "docktail.service.service-port=443"
      - "docktail.service.service-protocol=https"

  # TCP service protocol
  test-proto-tcp:
    image: nginx:alpine
    container_name: e2e-proto-tcp
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-proto-tcp"
      - "docktail.service.port=80"
      - "docktail.service.protocol=tcp"
      - "docktail.service.service-port=5432"
      - "docktail.service.service-protocol=tcp"

  # ============================================================================
  # 2. Smart Defaults
  # ============================================================================

  # Minimal labels: only enable + name + port → should default to http/80
  test-default-minimal:
    image: nginx:alpine
    container_name: e2e-default-minimal
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-default-minimal"
      - "docktail.service.port=80"

  # Only service-port=443 set, no protocol → should default to https
  test-default-port443:
    image: nginx:alpine
    container_name: e2e-default-port443
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-default-port443"
      - "docktail.service.port=80"
      - "docktail.service.service-port=443"

  # Only service-protocol=https set, no port → should default to port 443
  test-default-proto-https:
    image: nginx:alpine
    container_name: e2e-default-proto-https
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-default-proto-https"
      - "docktail.service.port=80"
      - "docktail.service.service-protocol=https"

  # Backend protocol=tcp, no service port/protocol → should default to tcp/80
  test-default-tcp-backend:
    image: nginx:alpine
    container_name: e2e-default-tcp-backend
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-default-tcp-backend"
      - "docktail.service.port=80"
      - "docktail.service.protocol=tcp"

  # ============================================================================
  # 3. Network Modes
  # ============================================================================

  # Direct mode on custom Docker network
  test-net-custom:
    image: nginx:alpine
    container_name: e2e-net-custom
    restart: "no"
    networks:
      - backend
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-net-custom"
      - "docktail.service.port=80"
      - "docktail.service.network=backend"

  # Published ports mode (direct=false)
  test-net-published:
    image: nginx:alpine
    container_name: e2e-net-published
    restart: "no"
    ports:
      - "19080:80"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-net-published"
      - "docktail.service.port=80"
      - "docktail.service.direct=false"

  # Host networking mode
  test-net-host:
    image: nginx:alpine
    container_name: e2e-net-host
    restart: "no"
    network_mode: host
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-net-host"
      - "docktail.service.port=80"

  # Container port 443, no protocol labels → backend should default to https, service to https/443
  test-default-target443:
    image: nginx:alpine
    container_name: e2e-default-target443
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-default-target443"
      - "docktail.service.port=443"

  # ============================================================================
  # 4. Funnel
  # ============================================================================

  # Service + HTTPS funnel on port 443
  test-funnel:
    image: nginx:alpine
    container_name: e2e-funnel
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-funnel"
      - "docktail.service.port=80"
      - "docktail.service.service-port=443"
      - "docktail.funnel.enable=true"
      - "docktail.funnel.port=80"

  # ============================================================================
  # 5. Custom Tags
  # ============================================================================

  # Container with custom tags (overrides default)
  test-custom-tags:
    image: nginx:alpine
    container_name: e2e-custom-tags
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-custom-tags"
      - "docktail.service.port=80"
      - "docktail.tags=tag:web,tag:production"

  # ============================================================================
  # 6. Multiple Services from One Container
  # ============================================================================

  # Container serving two separate Tailscale services (e.g., VPN gateway scenario)
  test-multiport:
    image: nginx:alpine
    container_name: e2e-multiport
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-multiport"
      - "docktail.service.port=80"
      - "docktail.service.service-port=443"
      - "docktail.service.service-protocol=https"
      - "docktail.service.1.name=e2e-multiport-secondary"
      - "docktail.service.1.port=80"
      - "docktail.service.1.service-port=8080"
      - "docktail.service.1.service-protocol=http"

  # Container serving three separate Tailscale services, non-contiguous indices
  test-multiport-three:
    image: nginx:alpine
    container_name: e2e-multiport-three
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-multiport-three"
      - "docktail.service.port=80"
      - "docktail.service.service-port=443"
      - "docktail.service.service-protocol=https"
      - "docktail.service.1.name=e2e-multiport-three-b"
      - "docktail.service.1.port=80"
      - "docktail.service.1.service-port=3000"
      - "docktail.service.1.service-protocol=http"
      - "docktail.service.3.name=e2e-multiport-three-c"
      - "docktail.service.3.port=80"
      - "docktail.service.3.service-port=5000"
      - "docktail.service.3.service-protocol=http"

  # ============================================================================
  # 7. Lifecycle (used for stop/removal tests)
  # ============================================================================

  test-lifecycle:
    image: nginx:alpine
    container_name: e2e-lifecycle
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-lifecycle"
      - "docktail.service.port=80"

  # ============================================================================
  # 8. Ignored Container (no docktail labels)
  # ============================================================================

  test-ignored:
    image: nginx:alpine
    container_name: e2e-ignored
    restart: "no"

  # ============================================================================
  # 9. Update/Change (starts as HTTP, switched to HTTPS mid-test)
  # ============================================================================

  test-update:
    image: nginx:alpine
    container_name: e2e-update
    restart: "no"
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=e2e-update"
      - "docktail.service.port=80"
      - "docktail.service.service-port=80"
      - "docktail.service.service-protocol=http"

networks:
  backend:

volumes:
  ts-state:
  ts-socket:
