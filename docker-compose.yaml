version: '3.8'

services:
  # DockTail service
  dev-docktail:
    build: .
    container_name: dev-docktail
    restart: unless-stopped
    volumes:
      # Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Tailscale socket for CLI communication
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock
    environment:
      - LOG_LEVEL=info
      - RECONCILE_INTERVAL=60s
    # Optional: use host network mode to avoid networking issues
    # network_mode: host

  # Example web application - nginx instance 1 (with HTTPS on Tailscale)
  web1:
    build: ./test/nginx-web1
    container_name: web1
    restart: unless-stopped
    ports:
      - "9080:80"  # HOST:CONTAINER - Publish container's port 80 to host's port 9080
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-web1"
      - "docktail.service.port=80"               # CONTAINER port (RIGHT side of "9080:80" above)
      - "docktail.service.protocol=http"         # Container speaks HTTP (Tailscale terminates TLS)
      - "docktail.service.service-port=443"      # Port to expose on Tailscale (defaults to HTTPS)
      - "docktail.service.service-protocol=https" # Tailscale serves HTTPS with auto TLS cert

  # Example web application - nginx instance 2 (using smart defaults)
  web2:
    build: ./test/nginx-web2
    container_name: web2
    restart: unless-stopped
    ports:
      - "9081:80"  # HOST:CONTAINER - Publish container's port 80 to host's port 9081
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-web2"
      - "docktail.service.port=80"  # CONTAINER port (RIGHT side of "9081:80" above)
      - "docktail.service.service-protocol=https"  # Tailscale serves HTTPS
      # service-port defaults to "443" (based on service-protocol=https)
      # protocol defaults to "http" (based on container port=80, not 443)

  # Example: Serve + Funnel (both tailnet AND public internet access)
  web-public:
    build: ./test/nginx-web1
    container_name: web-public
    restart: unless-stopped
    ports:
      - "9082:80"  # HOST:CONTAINER
    labels:
      # Serve configuration (tailnet-only):
      - "docktail.service.enable=true"               # Enable serve
      - "docktail.service.name=public-demo"          # Service name (tailnet only)
      - "docktail.service.port=80"                   # Container port for serve
      - "docktail.service.service-port=443"          # Tailnet HTTPS port

      # Funnel configuration (public internet):
      - "docktail.funnel.enable=true"                # ⚠️ Enable funnel (public access)
      - "docktail.funnel.port=80"                    # Container port for funnel

      # Result:
      # Tailnet: https://public-demo.<tailnet>.ts.net (serve)
      # Public:  https://<machine-name>.<tailnet>.ts.net:443 (funnel)

volumes:
  postgres-data:
