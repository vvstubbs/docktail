version: '3.8'

services:
  # DockTail service
  dev-docktail:
    build: .
    container_name: dev-docktail
    restart: unless-stopped
    volumes:
      # Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Tailscale socket directory (directory mount survives tailscaled restarts)
      - /var/run/tailscale:/var/run/tailscale
    environment:
      - LOG_LEVEL=debug
      - RECONCILE_INTERVAL=60s

  # Example: Direct mode (default) - no ports needed!
  web1:
    build: ./test/nginx-web1
    container_name: web1
    restart: unless-stopped
    # No ports needed - DockTail proxies directly to container IP
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-web1"
      - "docktail.service.port=80"
      - "docktail.service.protocol=http"
      - "docktail.service.service-port=80"
      - "docktail.service.service-protocol=http"

  # Example: Direct mode with HTTPS (using smart defaults)
  web2:
    build: ./test/nginx-web2
    container_name: web2
    restart: unless-stopped
    # No ports needed - DockTail proxies directly to container IP
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-web2"
      - "docktail.service.port=80"
      - "docktail.service.service-protocol=https"
      # service-port defaults to "443" (based on service-protocol=https)

  # Example: Serve + Funnel (both tailnet AND public internet access)
  web-public:
    build: ./test/nginx-web1
    container_name: web-public
    restart: unless-stopped
    # No ports needed - direct mode handles both serve and funnel
    labels:
      # Serve configuration (tailnet-only):
      - "docktail.service.enable=true"
      - "docktail.service.name=public-demo"
      - "docktail.service.port=80"
      - "docktail.service.service-port=443"

      # Funnel configuration (public internet):
      - "docktail.funnel.enable=true"
      - "docktail.funnel.port=80"

  # Example: TCP service with direct mode
  test-tcp:
    image: nginx:latest
    container_name: test-tcp
    restart: unless-stopped
    # No ports needed
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-tcp"
      - "docktail.service.port=80"
      - "docktail.service.protocol=tcp"

  # Example: Legacy mode (published ports) - opt out of direct mode
  test-legacy:
    image: nginx:latest
    container_name: test-legacy
    restart: unless-stopped
    ports:
      - "9080:80"  # Required when direct=false
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-legacy"
      - "docktail.service.port=80"
      - "docktail.service.direct=false"  # Use published port instead of container IP

  # Example: Custom Docker network
  test-custom-network:
    image: nginx:latest
    container_name: test-custom-network
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-custom-net"
      - "docktail.service.port=80"
      - "docktail.service.network=backend"  # Specify which network to use

  # Example: Host networking mode
  test-host-network:
    image: nginx:latest
    container_name: test-host-network
    restart: unless-stopped
    network_mode: host
    labels:
      - "docktail.service.enable=true"
      - "docktail.service.name=test-host"
      - "docktail.service.port=80"
      # Host network uses localhost directly

networks:
  backend:

volumes:
  postgres-data:
