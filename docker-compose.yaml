version: '3.8'

services:
  # ts-svc-autopilot service
  ts-svc-autopilot:
    build: .
    container_name: ts-svc-autopilot
    restart: unless-stopped
    volumes:
      # Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Tailscale socket for CLI communication
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock
    environment:
      - LOG_LEVEL=info
      - RECONCILE_INTERVAL=60s
    # Optional: use host network mode to avoid networking issues
    # network_mode: host

  # Example web application - nginx instance 1
  web1:
    build: ./nginx-web1
    container_name: web1
    restart: unless-stopped
    labels:
      - "ts-svc.enable=true"
      - "ts-svc.service=web1"
      - "ts-svc.port=443"
      - "ts-svc.target=80"
      - "ts-svc.protocol=https"

  # Example web application - nginx instance 2
  web2:
    build: ./nginx-web2
    container_name: web2
    restart: unless-stopped
    labels:
      - "ts-svc.enable=true"
      - "ts-svc.service=web2"
      - "ts-svc.port=8443"
      - "ts-svc.target=80"
      - "ts-svc.protocol=https"

  # Example database - PostgreSQL
  postgres:
    image: postgres:16
    container_name: example-postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_USER: myuser
      POSTGRES_DB: mydb
    labels:
      - "ts-svc.enable=true"
      - "ts-svc.service=db"
      - "ts-svc.port=5432"
      - "ts-svc.target=5432"
      - "ts-svc.protocol=tcp"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # Example API service - sample Node.js app
  # Uncomment to use
  # api:
  #   image: node:20-alpine
  #   container_name: example-api
  #   restart: unless-stopped
  #   working_dir: /app
  #   command: node server.js
  #   labels:
  #     - "ts-svc.enable=true"
  #     - "ts-svc.service=api"
  #     - "ts-svc.port=8080"
  #     - "ts-svc.target=3000"
  #     - "ts-svc.protocol=http"
  #   volumes:
  #     - ./api-code:/app

volumes:
  postgres-data:
